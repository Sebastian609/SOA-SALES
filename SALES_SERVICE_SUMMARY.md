# üõí SOA Sales Service - Documentaci√≥n Completa

## üìã Descripci√≥n General
Servicio especializado en la gesti√≥n de ventas y sus detalles para una arquitectura SOA. Este servicio maneja √∫nicamente las operaciones relacionadas con ventas, incluyendo la creaci√≥n, actualizaci√≥n, consulta y eliminaci√≥n de ventas y sus detalles asociados.

## üéØ Prop√≥sito del Servicio
Este servicio es responsable de:
- **Gesti√≥n de Ventas**: Crear, actualizar, consultar y eliminar ventas
- **Gesti√≥n de Detalles**: Manejar los detalles espec√≠ficos de cada venta
- **Estad√≠sticas**: Proporcionar m√©tricas y reportes de ventas
- **Integraci√≥n SOA**: Servir como microservicio independiente para operaciones de ventas

## üèóÔ∏è Arquitectura del Servicio

### 1. **Entidades** 
- **Sale** (`src/infrastructure/entity/sales.entity.ts`): Mapeo completo de la tabla `tbl_sales`
- **SaleDetail** (`src/infrastructure/entity/sale-details.entity.ts`): Mapeo completo de la tabla `tbl_sale_details`

### 2. **DTOs** (`src/infrastructure/dto/sales.dto.ts`)
- `CreateSaleDto`: Para crear ventas con detalles
- `CreateSaleDetailDto`: Para crear detalles de venta
- `UpdateSaleDto`: Para actualizar ventas existentes
- `UpdateSaleDetailDto`: Para actualizar detalles de venta

### 3. **Repositorio** (`src/repository/sales.repository.ts`)
- Implementa `IBaseRepository<Sale>`
- M√©todos espec√≠ficos para ventas:
  - `findByUserId()` / `findByPartnerId()`: Buscar ventas por usuario o partner
  - `findActiveSales()`: Obtener ventas activas
  - `getSalesStatistics()`: Estad√≠sticas de ventas
  - M√©todos para `SaleDetail`: CRUD completo para detalles

### 4. **Servicio** (`src/service/sales.service.ts`)
- L√≥gica de negocio para ventas
- Validaciones y transformaciones
- Gesti√≥n de transacciones
- Estad√≠sticas de ventas

### 5. **Controlador** (`src/infrastructure/controller/sales.controller.ts`)
- Manejo de requests HTTP
- Validaci√≥n de datos de entrada
- Respuestas estructuradas

### 6. **Rutas** (`src/routes/sales.routes.ts`)
- Definici√≥n de endpoints REST
- Documentaci√≥n Swagger integrada

### 7. **Configuraci√≥n**
- **Swagger** (`src/config/swagger.ts`): Solo esquemas de ventas
- **Servidor** (`src/server.ts`): Solo servicio de ventas

## üîÑ Flujo de Trabajo del Servicio

### 1. **Creaci√≥n de Venta**
```
1. Cliente env√≠a POST /api/sales con datos de venta y detalles
2. Controller valida datos con CreateSaleDto
3. Service procesa la l√≥gica de negocio
4. Repository crea la venta en la base de datos
5. Repository crea los detalles de venta asociados
6. Se retorna la venta completa con detalles
```

### 2. **Consulta de Ventas**
```
1. Cliente env√≠a GET /api/sales con par√°metros de paginaci√≥n
2. Controller procesa par√°metros de consulta
3. Service valida par√°metros de paginaci√≥n
4. Repository ejecuta consulta con relaciones
5. Se retorna lista paginada de ventas con detalles
```

### 3. **Actualizaci√≥n de Venta**
```
1. Cliente env√≠a PUT /api/sales con datos actualizados
2. Controller valida datos con UpdateSaleDto
3. Service verifica existencia de la venta
4. Repository actualiza la venta
5. Se retorna la venta actualizada
```

### 4. **Gesti√≥n de Detalles**
```
1. Cliente env√≠a PUT /api/sales/details para actualizar detalle
2. Controller valida datos con UpdateSaleDetailDto
3. Service verifica existencia del detalle
4. Repository actualiza el detalle
5. Se retorna el detalle actualizado
```

## üöÄ Endpoints Disponibles

### Gesti√≥n de Ventas
```
POST   /api/sales                    # Crear venta con detalles
PUT    /api/sales                    # Actualizar venta
GET    /api/sales                    # Lista paginada
GET    /api/sales/all                # Todas las ventas
GET    /api/sales/active             # Ventas activas
GET    /api/sales/statistics         # Estad√≠sticas
GET    /api/sales/{id}               # Venta por ID
GET    /api/sales/user/{userId}      # Ventas por usuario
GET    /api/sales/partner/{partnerId} # Ventas por partner
DELETE /api/sales/{id}/delete        # Eliminar venta (soft delete)
POST   /api/sales/{id}/activate      # Activar venta
POST   /api/sales/{id}/deactivate    # Desactivar venta
POST   /api/sales/{id}/restore       # Restaurar venta
```

### Gesti√≥n de Detalles de Venta
```
PUT    /api/sales/details            # Actualizar detalle de venta
GET    /api/sales/{saleId}/details   # Detalles de una venta
GET    /api/sales/details/{id}       # Detalle por ID
DELETE /api/sales/details/{id}/delete # Eliminar detalle (soft delete)
```

## üìä Casos de Uso Detallados

### 1. **Crear una Nueva Venta**
**Prop√≥sito**: Registrar una venta completa con m√∫ltiples detalles

**Flujo**:
1. El cliente (frontend/otro servicio) env√≠a una solicitud POST
2. Se incluyen datos de la venta y un array de detalles
3. El servicio valida todos los datos
4. Se crea la venta principal
5. Se crean todos los detalles asociados
6. Se retorna la venta completa con detalles

**Ejemplo de Request**:
```json
{
  "userId": 1,
  "partnerId": 1,
  "totalAmount": 150.00,
  "saleDetails": [
    {
      "ticketId": 1,
      "amount": 75.00
    },
    {
      "ticketId": 2,
      "amount": 75.00
    }
  ]
}
```

**Ejemplo de Response**:
```json
{
  "id": 1,
  "userId": 1,
  "partnerId": 1,
  "totalAmount": 150.00,
  "createdAt": "2024-01-01T10:00:00Z",
  "updatedAt": "2024-01-01T10:00:00Z",
  "isActive": true,
  "deleted": false,
  "saleDetails": [
    {
      "id": 1,
      "saleId": 1,
      "ticketId": 1,
      "amount": 75.00,
      "createdAt": "2024-01-01T10:00:00Z",
      "isActive": true
    },
    {
      "id": 2,
      "saleId": 1,
      "ticketId": 2,
      "amount": 75.00,
      "createdAt": "2024-01-01T10:00:00Z",
      "isActive": true
    }
  ]
}
```

### 2. **Consultar Ventas con Paginaci√≥n**
**Prop√≥sito**: Obtener lista paginada de ventas para interfaces de usuario

**Flujo**:
1. Cliente env√≠a GET con par√°metros page e items
2. Servicio valida par√°metros de paginaci√≥n
3. Repository ejecuta consulta con LIMIT y OFFSET
4. Se retorna objeto con ventas y contador total

**Ejemplo de Request**:
```
GET /api/sales?page=1&items=10
```

**Ejemplo de Response**:
```json
{
  "sales": [
    {
      "id": 1,
      "userId": 1,
      "totalAmount": 150.00,
      "createdAt": "2024-01-01T10:00:00Z",
      "saleDetails": [...]
    }
  ],
  "count": 25
}
```

### 3. **Obtener Estad√≠sticas de Ventas**
**Prop√≥sito**: Proporcionar m√©tricas para dashboards y reportes

**Flujo**:
1. Cliente env√≠a GET /api/sales/statistics
2. Repository ejecuta consultas agregadas
3. Se calculan m√©tricas en tiempo real
4. Se retorna objeto con estad√≠sticas

**Ejemplo de Response**:
```json
{
  "totalSales": 1000,
  "activeSales": 950,
  "totalRevenue": 50000.00,
  "averageSaleAmount": 50.00
}
```

### 4. **Actualizar Detalle de Venta**
**Prop√≥sito**: Modificar informaci√≥n espec√≠fica de un detalle

**Flujo**:
1. Cliente env√≠a PUT /api/sales/details
2. Se valida que el detalle existe
3. Se actualizan los campos especificados
4. Se retorna el detalle actualizado

**Ejemplo de Request**:
```json
{
  "id": 1,
  "amount": 80.00,
  "isActive": true
}
```

## üîß Caracter√≠sticas T√©cnicas

### Validaciones
- ‚úÖ Validaci√≥n de DTOs con class-validator
- ‚úÖ Transformaci√≥n de datos con class-transformer
- ‚úÖ Validaci√≥n de paginaci√≥n
- ‚úÖ Verificaci√≥n de existencia antes de operaciones

### Seguridad
- ‚úÖ Soft delete para preservar datos
- ‚úÖ Validaci√≥n de par√°metros de entrada
- ‚úÖ Manejo de errores estructurado

### Base de Datos
- **Tabla**: `tbl_sales`
- **Tabla**: `tbl_sale_details`
- ‚úÖ Relaciones entre entidades
- ‚úÖ √çndices optimizados
- ‚úÖ Transacciones ACID

### Manejo de Errores
```json
{
  "message": "Sale with ID 999 not found"
}
```

## üìä Ejemplos de Uso Pr√°cticos

### 1. Crear una Venta
```bash
curl -X POST http://localhost:2226/api/sales \
  -H "Content-Type: application/json" \
  -d '{
    "userId": 1,
    "partnerId": 1,
    "totalAmount": 100.00,
    "saleDetails": [
      {
        "ticketId": 1,
        "amount": 50.00
      },
      {
        "ticketId": 2,
        "amount": 50.00
      }
    ]
  }'
```

### 2. Obtener Estad√≠sticas
```bash
curl -X GET http://localhost:2226/api/sales/statistics
```

### 3. Obtener Ventas por Usuario
```bash
curl -X GET http://localhost:2226/api/sales/user/1
```

### 4. Actualizar Detalle de Venta
```bash
curl -X PUT http://localhost:2226/api/sales/details \
  -H "Content-Type: application/json" \
  -d '{
    "id": 1,
    "amount": 75.00
  }'
```

## üè• Health Check
```bash
curl -X GET http://localhost:2226/api/health
```

Respuesta:
```json
{
  "status": "OK",
  "message": "SOA Sales API is running",
  "timestamp": "2024-01-01T00:00:00.000Z"
}
```

## üóÑÔ∏è Estructura de Base de Datos

### Tabla `tbl_sales`
```sql
CREATE TABLE `tbl_sales` (
  `sale_id` int NOT NULL AUTO_INCREMENT,
  `user_id` int DEFAULT NULL,
  `partner_id` int DEFAULT NULL,
  `total_amount` decimal(10,2) DEFAULT NULL,
  `created_at` timestamp NULL DEFAULT CURRENT_TIMESTAMP,
  `updated_at` timestamp NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  `is_active` tinyint(1) DEFAULT '1',
  `deleted` tinyint(1) DEFAULT '0',
  PRIMARY KEY (`sale_id`)
);
```

### Tabla `tbl_sale_details`
```sql
CREATE TABLE `tbl_sale_details` (
  `sale_detail_id` int NOT NULL AUTO_INCREMENT,
  `sale_id` int DEFAULT NULL,
  `ticket_id` int DEFAULT NULL,
  `amount` decimal(10,2) DEFAULT NULL,
  `created_at` timestamp NULL DEFAULT CURRENT_TIMESTAMP,
  `updated_at` timestamp NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  `is_active` tinyint(1) DEFAULT '1',
  `deleted` tinyint(1) DEFAULT '0',
  PRIMARY KEY (`sale_detail_id`),
  KEY `fk_sale_details_sale` (`sale_id`),
  CONSTRAINT `fk_sale_details_sale` FOREIGN KEY (`sale_id`) REFERENCES `tbl_sales` (`sale_id`)
);
```

## üìÅ Estructura de Archivos
```
src/
‚îú‚îÄ‚îÄ config/
‚îÇ   ‚îî‚îÄ‚îÄ swagger.ts                    # Configuraci√≥n de Swagger
‚îú‚îÄ‚îÄ infrastructure/
‚îÇ   ‚îú‚îÄ‚îÄ controller/
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ sales.controller.ts       # Controlador de ventas
‚îÇ   ‚îú‚îÄ‚îÄ database/
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ database.ts               # Configuraci√≥n de base de datos
‚îÇ   ‚îú‚îÄ‚îÄ dto/
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ sales.dto.ts              # DTOs para ventas
‚îÇ   ‚îú‚îÄ‚îÄ entity/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ sales.entity.ts           # Entidad Sale
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ sale-details.entity.ts    # Entidad SaleDetail
‚îÇ   ‚îî‚îÄ‚îÄ interfaces/
‚îÇ       ‚îî‚îÄ‚îÄ pagination.interface.ts   # Interfaz de paginaci√≥n
‚îú‚îÄ‚îÄ repository/
‚îÇ   ‚îú‚îÄ‚îÄ base-repository.interface.ts  # Interfaz base del repositorio
‚îÇ   ‚îî‚îÄ‚îÄ sales.repository.ts           # Repositorio de ventas
‚îú‚îÄ‚îÄ routes/
‚îÇ   ‚îî‚îÄ‚îÄ sales.routes.ts               # Rutas de ventas
‚îú‚îÄ‚îÄ service/
‚îÇ   ‚îî‚îÄ‚îÄ sales.service.ts              # Servicio de ventas
‚îú‚îÄ‚îÄ test/
‚îÇ   ‚îî‚îÄ‚îÄ sales.test.ts                 # Pruebas unitarias
‚îú‚îÄ‚îÄ utils/
‚îÇ   ‚îî‚îÄ‚îÄ getPaginated.ts               # Utilidad de paginaci√≥n
‚îî‚îÄ‚îÄ server.ts                         # Servidor principal
```

## üîÑ Integraci√≥n en Arquitectura SOA

### Comunicaci√≥n con Otros Servicios
- **Servicio de Usuarios**: Referencia por `userId`
- **Servicio de Partners**: Referencia por `partnerId`
- **Servicio de Tickets**: Referencia por `ticketId` en detalles

### Patrones de Integraci√≥n
- **Synchronous**: Para operaciones cr√≠ticas
- **Asynchronous**: Para notificaciones y eventos
- **Event-Driven**: Para actualizaciones en tiempo real

## ‚úÖ Estado de Implementaci√≥n

### ‚úÖ Completado
- ‚úÖ **Entidad Sale**: Completamente implementada
- ‚úÖ **Entidad SaleDetail**: Completamente implementada
- ‚úÖ **DTOs**: Todos los DTOs necesarios
- ‚úÖ **Repositorio**: CRUD completo con m√©todos espec√≠ficos
- ‚úÖ **Servicio**: L√≥gica de negocio completa
- ‚úÖ **Controlador**: Manejo de requests HTTP
- ‚úÖ **Rutas**: Todos los endpoints necesarios
- ‚úÖ **Swagger**: Documentaci√≥n completa
- ‚úÖ **Pruebas**: Pruebas unitarias b√°sicas
- ‚úÖ **Validaciones**: Validaci√≥n de datos completa
- ‚úÖ **Manejo de Errores**: Estructurado y consistente
- ‚úÖ **Paginaci√≥n**: Implementada correctamente
- ‚úÖ **Soft Delete**: Preservaci√≥n de datos
- ‚úÖ **Estad√≠sticas**: M√©tricas de ventas
- ‚úÖ **Relaciones**: Entre Sale y SaleDetail
- ‚úÖ **Servicio √önico**: Solo maneja ventas, sin usuarios/roles/sockets

### üéØ Caracter√≠sticas Principales
- ‚úÖ Gesti√≥n completa de ventas y detalles.
- ‚úÖ API RESTful bien documentada
- ‚úÖ Validaci√≥n robusta de datos
- ‚úÖ Manejo de errores consistente
- ‚úÖ Paginaci√≥n eficiente
- ‚úÖ Estad√≠sticas en tiempo real
- ‚úÖ Soft delete para preservar datos
- ‚úÖ Relaciones entre entidades
- ‚úÖ Documentaci√≥n Swagger completa
- ‚úÖ Pruebas unitarias
- ‚úÖ Arquitectura SOA optimizada

## üéâ Resumen
**üéâ El servicio de ventas est√° completamente implementado y optimizado para manejar √∫nicamente ventas y sus detalles en una arquitectura SOA!**

### Puerto de Ejecuci√≥n
- **Puerto**: 2226
- **URL Base**: `http://localhost:2226`
- **Documentaci√≥n**: `http://localhost:2226/api-docs`
- **Health Check**: `http://localhost:2226/api/health`

### Pr√≥ximos Pasos
1. **Despliegue**: Configurar en entorno de producci√≥n
2. **Monitoreo**: Implementar logs y m√©tricas
3. **Escalabilidad**: Configurar load balancing
4. **Seguridad**: Implementar autenticaci√≥n y autorizaci√≥n
5. **Testing**: Ejecutar pruebas de integraci√≥n 